name: Test Worthit Scripts

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-linux:
    name: Test Linux Script
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Make script executable
      run: chmod +x src/worthit-linux.sh

    - name: Test script with sample transcript
      run: |
        export HOOK_INPUT='{"transcript_path": "tests/test-transcript.jsonl"}'
        echo "$HOOK_INPUT" | src/worthit-linux.sh

    - name: Verify script syntax
      run: bash -n src/worthit-linux.sh

    - name: Test Python script extraction
      run: |
        # Extract and test Python script
        sed -n '/^RESULT=\$(python3 - "\$HOOK_INPUT" <<'\''PYTHON_SCRIPT'\''/,/^PYTHON_SCRIPT$/p' src/worthit-linux.sh | \
        sed '1d;$d' > /tmp/test_script.py
        python3 -m py_compile /tmp/test_script.py

  test-macos:
    name: Test macOS Script
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Make script executable
      run: chmod +x src/worthit-macos.sh

    - name: Test script with sample transcript
      run: |
        export HOOK_INPUT='{"transcript_path": "tests/test-transcript.jsonl"}'
        echo "$HOOK_INPUT" | src/worthit-macos.sh

    - name: Verify script syntax
      run: bash -n src/worthit-macos.sh

    - name: Test Python script extraction
      run: |
        # Extract and test Python script
        sed -n '/^RESULT=\$(python3 - "\$HOOK_INPUT" <<'\''PYTHON_SCRIPT'\''/,/^PYTHON_SCRIPT$/p' src/worthit-macos.sh | \
        sed '1d;$d' > /tmp/test_script.py
        python3 -m py_compile /tmp/test_script.py

  test-windows:
    name: Test Windows/WSL Script
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Make script executable
      run: chmod +x src/worthit-windows.sh

    - name: Test script with sample transcript (without PowerShell)
      run: |
        # Test Python logic without PowerShell (unavailable in CI)
        export HOOK_INPUT='{"transcript_path": "tests/test-transcript.jsonl"}'
        # Run script but ignore notification errors
        echo "$HOOK_INPUT" | src/worthit-windows.sh || true

    - name: Verify script syntax
      run: bash -n src/worthit-windows.sh

    - name: Test Python script extraction
      run: |
        # Extract and test Python script
        sed -n '/^RESULT=\$(python3 - "\$HOOK_INPUT" <<'\''PYTHON_SCRIPT'\''/,/^PYTHON_SCRIPT$/p' src/worthit-windows.sh | \
        sed '1d;$d' > /tmp/test_script.py
        python3 -m py_compile /tmp/test_script.py

  test-install-script:
    name: Test Installation Script
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Make install script executable
      run: chmod +x install.sh

    - name: Verify install script syntax
      run: bash -n install.sh

    - name: Test platform detection
      run: |
        # Extract and test platform detection function
        source <(sed -n '/^detect_platform()/,/^}$/p' install.sh)
        PLATFORM=$(detect_platform)
        echo "Detected platform: $PLATFORM"
        [ "$PLATFORM" = "linux" ] || [ "$PLATFORM" = "windows" ] || [ "$PLATFORM" = "macos" ]

  test-transcript-format:
    name: Validate Test Transcript
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate JSONL format
      run: |
        python3 -c "
        import json
        with open('tests/test-transcript.jsonl', 'r') as f:
            for line_num, line in enumerate(f, 1):
                try:
                    json.loads(line.strip())
                except json.JSONDecodeError as e:
                    print(f'Error on line {line_num}: {e}')
                    exit(1)
        print('JSONL format is valid')
        "

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Make scripts executable
      run: chmod +x src/worthit-linux.sh

    - name: Test path traversal protection
      run: |
        # These should fail (return non-zero)
        ! echo '{"transcript_path": "../../etc/passwd"}' | src/worthit-linux.sh
        ! echo '{"transcript_path": "../../../root/.bashrc"}' | src/worthit-linux.sh
        echo "✓ Path traversal protection working"

    - name: Test command injection protection
      run: |
        # These should fail (return non-zero)
        ! echo '{"transcript_path": "$(whoami).jsonl"}' | src/worthit-linux.sh
        ! echo '{"transcript_path": "`whoami`.jsonl"}' | src/worthit-linux.sh
        ! echo '{"transcript_path": "$HOME/test.jsonl"}' | src/worthit-linux.sh
        echo "✓ Command injection protection working"

    - name: Test JSON validation
      run: |
        # These should fail (return non-zero)
        ! echo 'not valid json' | src/worthit-linux.sh
        ! echo '{}' | src/worthit-linux.sh
        ! echo '{"other_field": "value"}' | src/worthit-linux.sh
        ! echo '{"transcript_path": 123}' | src/worthit-linux.sh
        echo "✓ JSON validation working"

  unit-tests:
    name: Python Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Run sanitization tests
      run: python3 tests/unit/test_sanitization.py

    - name: Run pricing tests
      run: python3 tests/unit/test_pricing.py

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Make scripts executable
      run: chmod +x src/worthit-linux.sh tests/integration/test_full_flow.sh

    - name: Run integration test suite
      run: tests/integration/test_full_flow.sh

  all-tests-passed:
    name: All Tests Passed
    needs: [test-linux, test-macos, test-windows, test-install-script, test-transcript-format, security-tests, unit-tests, integration-tests]
    runs-on: ubuntu-latest

    steps:
    - name: Success
      run: echo "All tests passed successfully!"
